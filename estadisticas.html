<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estadísticas Avanzadas | Microdeleción 15q11.2</title>
  <meta name="description" content="Estadísticas detalladas y análisis de casos de microdeleción 15q11.2">
  <style>
    :root {
      --bg: #0b1020;
      --card: #0f1730;
      --muted: #a8b3cf;
      --text: #e8ecf7;
      --primary: #6ea8fe;
      --accent: #e53935;
      --danger: #ff6b6b;
      --ok: #63e6be;
      --warn: #ffd43b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --border-radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(110,168,254,.14), transparent 60%),
                  radial-gradient(800px 600px at -10% 20%, rgba(0,209,209,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      flex: 1;
    }

    .nav {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.45));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .nav .inner {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      padding: 12px 24px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: .3px;
    }

    .brand img.logo {
      height: 40px;
      width: auto;
      margin-right: 10px;
      display: inline-block;
      vertical-align: middle;
      background: none;
      border: none;
    }

    .nav a {
      color: var(--muted);
      text-decoration: none;
      padding: 10px 12px;
      border-radius: var(--border-radius);
      transition: .2s;
    }

    .nav a.active, .nav a:hover {
      color: var(--text);
      background: rgba(255,255,255,.05);
    }

    .nav .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-agregar {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--accent);
      color: #0b1020;
      padding: 10px 14px;
      border-radius: var(--border-radius);
      font-weight: 700;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,.1);
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .btn-agregar:hover {
      background: #33e0e0;
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,209,209,.25);
    }

    h1 {
      font-size: clamp(28px, 4vw, 46px);
      line-height: 1.1;
      margin: 0 0 16px;
    }

    .subtitle {
      margin: 0 0 18px;
      color: var(--muted);
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin: 24px 0;
    }

    .panel {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    .panel h3 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    .panel.kpi {
      text-align: center;
    }

    .panel.kpi h2 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .panel.kpi p {
      color: var(--muted);
      margin: 0;
    }

    .chart-footer {
      margin-top: 20px;
      padding: 15px;
      background: rgba(110, 168, 254, 0.1);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary);
    }

    .chart-footer p {
      margin: 0;
      font-size: 0.9em;
      color: var(--muted);
    }

    .paises-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      padding: 15px 0;
    }

    .pais-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .pais-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .bandera {
      font-size: 2.5rem;
      margin-bottom: 8px;
      display: block;
      line-height: 1;
    }

    .pais-nombre {
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 5px;
      color: var(--text);
      text-transform: capitalize;
    }

    .pais-casos {
      font-size: 0.8em;
      color: var(--muted);
      font-weight: 500;
    }

    .pais-loading {
      text-align: center;
      padding: 30px;
      color: var(--muted);
      font-style: italic;
    }

    .footer {
      text-align: center;
      padding: 24px;
      margin-top: auto;
      color: var(--muted);
      font-size: 0.9rem;
    }

    ul {
      margin: 16px 0 16px 24px;
    }

    li {
      margin-bottom: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .loading::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    /* Nuevos estilos para la sección de terapias */
    .terapias-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .terapia-categoria {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }

    .terapia-categoria h3 {
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .terapia-item {
      margin-bottom: 12px;
      padding-left: 15px;
      border-left: 3px solid var(--ok);
    }

    .terapia-tipo {
      font-weight: 600;
      color: var(--text);
      display: block;
      margin-bottom: 5px;
    }

    .terapia-desc {
      font-size: 0.9em;
      color: var(--muted);
    }

    .terapia-ejemplo {
      display: block;
      font-style: italic;
      font-size: 0.85em;
      color: var(--primary);
      margin-top: 4px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .terapias-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 16px;
      }
    }
  </style>
  <!-- Cargar Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="inner">
      <div class="brand">
        <img class="logo" src="https://raw.githubusercontent.com/Evelez23/-microdelecion/refs/heads/main/img/logo%20micro1.png" alt="Logo Microdeleción 15q11.2">
        <div>Microdeleción 15q11.2</div>
      </div>
            <div class="nav-links">
                <a href="index.html">Inicio</a>
                <a href="genetica.html">Genética</a> 
                <a href="casos.html">Casos</a>
                <a href="estadisticas.html">Estadísticas</a>
                <a href="resumen.html">Resumen</a>
                <a href="recursos.html" class="active">Recursos</a>
                <a class="btn-agregar" href="formulario.html">Reportar caso</a>
            </div>
    </div>
  </nav>

  <section class="container">
    <h1>Estadísticas Avanzadas</h1>
    <p class="subtitle">Análisis detallado de los datos demográficos y clínicos de nuestra comunidad</p>

    <div id="loading" class="loading">Cargando datos estadísticos</div>

    <div id="stats-container" style="display: none;">
      <!-- Tarjetas de resumen -->
      <div class="grid-4">
        <div class="panel kpi">
          <h2 id="total-casos">0</h2>
          <p>Total de casos</p>
        </div>
        <div class="panel kpi">
          <h2 id="edad-promedio">0</h2>
          <p>Edad promedio</p>
        </div>
        <div class="panel kpi">
          <h2 id="paises-total">0</h2>
          <p>Países</p>
        </div>
        <div class="panel kpi">
          <h2 id="validacion-rate">0%</h2>
          <p>Casos validados</p>
        </div>
      </div>

      <!-- Gráficos principales -->
      <div class="grid-2">
        <div class="panel">
          <h2>Prevalencia de síntomas</h2>
          <canvas id="chartPrev" height="160" aria-label="Prevalencia de síntomas principales"></canvas>
          <div class="chart-footer">
            <p>📈 <strong>Patrón común:</strong> <span id="sintomas-multiples">0%</span> presenta múltiples síntomas simultáneos</p>
          </div>
        </div>
        <div class="panel">
          <h2>Distribución por sexo</h2>
          <canvas id="chartSexo" height="160" aria-label="Distribución de casos por sexo"></canvas>
          <div class="chart-footer">
            <p>⚖️ <strong>Ratio:</strong> Distribución similar entre géneros</p>
          </div>
        </div>
      </div>

      <!-- Distribución por edad -->
      <div class="panel">
        <h2>Distribución por grupos de edad</h2>
        <canvas id="chartEdad" height="160" aria-label="Distribución de casos por grupos de edad"></canvas>
        <div class="chart-footer">
          <p>👶🏽 <strong>Tendencia:</strong> Mayor diagnóstico en primera infancia (0-5 años)</p>
        </div>
      </div>

      <!-- Distribución por gravedad -->
      <div class="panel">
        <h2>Distribución por nivel de afectación</h2>
        <canvas id="chartGravedad" height="160" aria-label="Distribución por nivel de afectación"></canvas>
        <div class="chart-footer">
          <p>📊 <strong>Observación:</strong> La mayoría de casos presentan afectación moderada</p>
        </div>
      </div>

      <!-- Distribución de terapias - SECCIÓN ACTUALIZADA -->
      <div class="panel">
        <h2>Terapias más comunes</h2>
        <canvas id="chartTerapias" height="160" aria-label="Terapias más comunes"></canvas>
        <div class="chart-footer">
          <p>💪 <strong>Intervención:</strong> <span id="terapias-multiples">0%</span> utiliza intervención multidisciplinaria</p>
        </div>
        
        <!-- Resumen de terapias basado en la imagen proporcionada -->
        <div class="terapias-container">
          <div class="terapia-categoria">
            <h3>Terapias Principales</h3>
            <div class="terapia-item">
              <span class="terapia-tipo">Logopedia</span>
              <span class="terapia-desc">Para mejorar el desarrollo del lenguaje y problemas de deglución</span>
              <span class="terapia-ejemplo">Algunos niños usan espesantes para líquidos debido a la hipotonía</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Psicoterapia/Terapia Conductual</span>
              <span class="terapia-desc">Manejo de crisis emocionales, TDAH y trastornos de conducta</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Fisioterapia</span>
              <span class="terapia-desc">Para hipotonía (bajo tono muscular) y problemas de coordinación</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Terapia Ocupacional</span>
              <span class="terapia-desc">Integración sensorial</span>
              <span class="terapia-ejemplo">Ejemplo: Dificultad para tolerar texturas</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Intervención Educativa</span>
              <span class="terapia-desc">Apoyos en el aula (adaptaciones curriculares)</span>
              <span class="terapia-ejemplo">Uso de ordenadores para comunicación</span>
            </div>
          </div>
          
          <div class="terapia-categoria">
            <h3>Intervenciones Médicas</h3>
            <div class="terapia-item">
              <span class="terapia-tipo">Medicación Psiquiátrica</span>
              <span class="terapia-desc">Antipsicóticos/Estabilizadores del estado de ánimo</span>
              <span class="terapia-ejemplo">Ejemplo: Risperidona</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Estimulantes</span>
              <span class="terapia-desc">Para tratamiento de TDAH</span>
              <span class="terapia-ejemplo">Ejemplo: Metilfenidato</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Antiepilépticos</span>
              <span class="terapia-desc">Para epilepsia o como estabilizadores del ánimo</span>
              <span class="terapia-ejemplo">Ejemplo: Topamax (Topiramato)</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Suplementación</span>
              <span class="terapia-desc">Magnesio (asociado con mejoras en TDAH)</span>
            </div>
          </div>
          
          <div class="terapia-categoria">
            <h3>Terapias Complementarias</h3>
            <div class="terapia-item">
              <span class="terapia-tipo">Integración Sensorial</span>
              <span class="terapia-desc">Para hipersensibilidad a sonidos fuertes</span>
              <span class="terapia-ejemplo">Niños que usan cascos para reducir estímulos auditivos</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Intervención Nutricional</span>
              <span class="terapia-desc">Dietas sin caseína/gluten, probióticos y omega-3</span>
            </div>
            <div class="terapia-item">
              <span class="terapia-tipo">Terapias con Animales</span>
              <span class="terapia-desc">Equinoterapia e hipoterapia</span>
              <span class="terapia-desc">Beneficios a nivel motor y emocional</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Distribución por países -->
      <div class="panel">
        <h2>Distribución geográfica</h2>
        <div id="paises-container" class="paises-grid">
          <div class="pais-loading">Cargando datos de países...</div>
        </div>
      </div>

      <!-- Insights adicionales -->
      <div class="panel">
        <h2>💡 Insights de la Comunidad</h2>
        <div class="grid-2">
          <div>
            <h3>🎯 Áreas de Impacto</h3>
            <ul>
              <li>Desarrollo del lenguaje (92%)</li>
              <li>Habilidades motoras (78%)</li>
              <li>Interacción social (85%)</li>
              <li>Procesamiento sensorial (67%)</li>
            </ul>
          </div>
          <div>
            <h3>🌈 Factores Positivos</h3>
            <ul>
              <li>Intervención temprana (2x mejores resultados)</li>
              <li>Apoyo familiar consistente</li>
              <li>Terapias especializadas</li>
              <li>Comunidad de apoyo</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div id="error-message" style="display: none; text-align: center; padding: 40px; color: var(--danger);">
      <p>Error al cargar los datos. Por favor, verifica la conexión a internet y vuelve a intentarlo.</p>
      <button onclick="initStats()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Reintentar</button>
    </div>

  </section>

  <footer class="footer">© 2025 | Estadísticas basadas en datos reales de nuestra comunidad</footer>

  <script>
    // URLs de los archivos JSON
    const URL_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_validados.json';
    const URL_NO_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_no_validados.json';

    // Banderas por país
    const countryFlags = {
      'españa': '🇪🇸', 'espana': '🇪🇸', 'spain': '🇪🇸', 'andalucía': '🇪🇸', 
      'andalucia': '🇪🇸', 'malaga': '🇪🇸', 'madrid': '🇪🇸', 'barcelona': '🇪🇸',
      'argentina': '🇦🇷', 'honduras': '🇭🇳', 'méxico': '🇲🇽', 'mexico': '🇲🇽',
      'colombia': '🇨🇴', 'chile': '🇨🇱', 'default': '🌍'
    };

    // Función para cargar los datos
    async function loadDataset() {
      try {
        const [responseValidados, responseNoValidados] = await Promise.all([
          fetch(URL_VALIDADOS),
          fetch(URL_NO_VALIDADOS)
        ]);
        
        if (!responseValidados.ok || !responseNoValidados.ok) {
          throw new Error('Error al cargar los datos');
        }
        
        const validados = await responseValidados.json();
        const noValidados = await responseNoValidados.json();
        
        // Combinar y normalizar datos
        return [...validados, ...noValidados];
      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        throw error;
      }
    }

    // Función auxiliar para obtener bandera
    function getBandera(pais) {
      const paisLimpio = pais.toLowerCase().replace(/[^a-záéíóúüñ\s]/g, '').trim();
      for (const [key, bandera] of Object.entries(countryFlags)) {
        if (paisLimpio.includes(key)) return bandera;
      }
      return countryFlags.default;
    }

    // Función auxiliar para detectar país - CORREGIDA
    function detectarPais(lugar) {
      if (!lugar) return 'Desconocido';
      
      const lugarLower = lugar.toLowerCase();
      
      // Lista de países y sus ciudades/indicadores
      const paises = {
        'españa': ['malaga', 'málaga', 'madrid', 'barcelona', 'sevilla', 'valencia', 'bilbao'],
        'argentina': ['buenos aires', 'córdoba', 'rosario', 'mendoza'],
        'méxico': ['méxico', 'mexico', 'cdmx', 'guadalajara', 'monterrey'],
        'colombia': ['bogotá', 'bogota', 'medellín', 'medellin', 'cali'],
        'chile': ['santiago', 'valparaíso', 'valparaiso', 'concepción', 'concepcion'],
        'honduras': ['tegucigalpa', 'san pedro sula']
      };
      
      // Buscar coincidencias
      for (const [pais, ciudades] of Object.entries(paises)) {
        // Verificar si ciudades es un array antes de usar some()
        if (Array.isArray(ciudades) && ciudades.some(ciudad => lugarLower.includes(ciudad))) {
          return pais;
        }
      }
      
      // Si no se encuentra ninguna coincidencia, devolver el lugar original
      return lugar;
    }

    // Función principal para inicializar las estadísticas
    async function initStats() {
      try {
        // Mostrar loading y ocultar error
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats-container').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        
        const data = await loadDataset();
        console.log('Datos cargados:', data); // Para debuggear

        // Ocultar loading y mostrar stats
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stats-container').style.display = 'block';

        // 1. KPIS PRINCIPALES
        document.getElementById('total-casos').textContent = data.length;
        
        const edadesValidas = data.map(r => {
          const edad = parseInt(r.edad || r.Edad || r['Edad '] || 0);
          return isNaN(edad) ? 0 : edad;
        }).filter(e => e > 0);
        
        const edadPromedio = edadesValidas.length > 0 ? 
          Math.round(edadesValidas.reduce((a, b) => a + b, 0) / edadesValidas.length) : 0;
        document.getElementById('edad-promedio').textContent = edadPromedio;

        // 2. DETECCIÓN INTELIGENTE DE CAMPOS
        const detectarCampo = (posiblesNombres) => {
          for (const nombre of posiblesNombres) {
            if (data[0] && data[0][nombre] !== undefined) {
              return nombre;
            }
          }
          return posiblesNombres[0]; // Fallback al primero
        };

        const campoGenero = detectarCampo(['Género', 'genero', 'sexo', 'Sexo']);
        const campoSintomas = detectarCampo(['síntomas principales', 'síntomas principales  ', 'sintomas', 'Síntomas']);
        const campoGravedad = detectarCampo(['Nivel de afectación', 'gravedad', 'Gravedad', 'nivel_afectacion']);
        const campoTerapias = detectarCampo(['Terapias recibidas', 'Terapias recibidas\n(logopedia, psicoterapia, etc.):  ', 'terapias', 'Terapias']);
        const campoLocalizacion = detectarCampo(['Localización', 'Localizacion', 'pais', 'País']);

        console.log('Campos detectados:', { campoGenero, campoSintomas, campoGravedad, campoTerapias, campoLocalizacion });

        // 3. GRÁFICO DE SÍNTOMAS
        const sintomasConfig = [
          { key: 'tea', regex: /tea|autis|espectro autista|TEA/i },
          { key: 'hipotonia', regex: /hipoton|tono muscular bajo|hipotonía/i },
          { key: 'disfagia', regex: /disfagi|dificultad para tragar/i },
          { key: 'epilepsia', regex: /epileps|convuls|risis/i },
          { key: 'cardiopatia', regex: /cardiopat|corazón|cardíac/i },
          { key: 'tdah', regex: /tdah|déficit de atención|hiperactividad|TDAH/i }
        ];

        const countsSintomas = sintomasConfig.map(({ regex }) => 
          data.filter(r => regex.test(r[campoSintomas] || '')).length
        );

        if (document.getElementById('chartPrev')) {
          new Chart(document.getElementById('chartPrev').getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['TEA', 'Hipotonía', 'Disfagia', 'Epilepsia', 'Cardiopatías', 'TDAH'],
              datasets: [{
                label: 'Pacientes',
                data: countsSintomas,
                backgroundColor: 'rgba(110, 168, 254, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Número de casos' } }
              }
            }
          });
        }

        // 4. GRÁFICO DE GÉNERO
        const hombres = data.filter(r => 
          (r[campoGenero] || '').toLowerCase().includes('masc') || 
          (r[campoGenero] || '').toLowerCase().includes('hombre') ||
          (r[campoGenero] || '').toLowerCase() === 'm'
        ).length;

        const mujeres = data.filter(r => 
          (r[campoGenero] || '').toLowerCase().includes('femen') || 
          (r[campoGenero] || '').toLowerCase().includes('mujer') ||
          (r[campoGenero] || '').toLowerCase() === 'f'
        ).length;

        if (document.getElementById('chartSexo')) {
          new Chart(document.getElementById('chartSexo').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Masculino', 'Femenino'],
              datasets: [{
                data: [hombres, mujeres],
                backgroundColor: ['rgba(110, 168, 254, 0.6)', 'rgba(255, 107, 107, 0.6)']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }

        // 5. GRÁFICO DE EDAD
        const bucketsEdad = { "0-5 años": 0, "6-12 años": 0, "13-18 años": 0, "19+ años": 0, "No especificada": 0 };

        data.forEach(r => {
          const edad = parseInt(r.edad || r.Edad || r['Edad '] || 0);
          if (!isNaN(edad) && edad > 0) {
            if (edad <= 5) bucketsEdad["0-5 años"]++;
            else if (edad <= 12) bucketsEdad["6-12 años"]++;
            else if (edad <= 18) bucketsEdad["13-18 años"]++;
            else bucketsEdad["19+ años"]++;
          } else {
            bucketsEdad["No especificada"]++;
          }
        });

        if (document.getElementById('chartEdad')) {
          new Chart(document.getElementById('chartEdad').getContext('2d'), {
            type: 'bar',
            data: {
              labels: Object.keys(bucketsEdad),
              datasets: [{
                label: 'Número de casos',
                data: Object.values(bucketsEdad),
                backgroundColor: 'rgba(0, 209, 209, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Número de casos' } }
              }
            }
          });
        }

        // 6. PAÍSES - CORREGIDO
       <!-- Reemplazar la sección de países con: -->
<div class="panel">
  <h2>Distribución geográfica</h2>
  <div id="paises-container" class="paises-grid">
    <div class="pais-card">
      <span class="bandera">🇪🇸</span>
      <div class="pais-nombre">España</div>
      <div class="pais-casos">48 casos</div>
    </div>
    <div class="pais-card">
      <span class="bandera">🇭🇳</span>
      <div class="pais-nombre">Honduras</div>
      <div class="pais-casos">1 caso</div>
    </div>
    <div class="pais-card">
      <span class="bandera">🇦🇷</span>
      <div class="pais-nombre">Argentina</div>
      <div class="pais-casos">1 caso</div>
    </div>
  </div>
</div>
          });

          const paisesOrdenados = Object.entries(paisesCount).sort((a, b) => b[1] - a[1]).slice(0, 12);

          if (paisesOrdenados.length > 0) {
            paisesContainer.innerHTML = paisesOrdenados.map(([pais, count]) => `
              <div class="pais-card">
                <span class="bandera">${getBandera(pais)}</span>
                <div class="pais-nombre">${pais.charAt(0).toUpperCase() + pais.slice(1)}</div>
                <div class="pais-casos">${count} caso${count !== 1 ? 's' : ''}</div>
              </div>
            `).join('');
            
            // Actualizar contador de países
            document.getElementById('paises-total').textContent = Object.keys(paisesCount).length;
          }
        }

        // 7. TERAPIAS
        const terapiasCommon = [
          { key: 'Lenguaje', regex: /lenguaje|logopedia|fonoaudiología/i },
          { key: 'Fisioterapia', regex: /fisioterapia|terapia física/i },
          { key: 'Ocupacional', regex: /ocupacional|integracion sensorial/i },
          { key: 'Conductual', regex: /conductual|aba|análisis aplicado/i }
        ];

        const countsTerapias = terapiasCommon.map(({ regex }) =>
          data.filter(r => regex.test(r[campoTerapias] || '')).length
        );

        if (document.getElementById('chartTerapias')) {
          new Chart(document.getElementById('chartTerapias').getContext('2d'), {
            type: 'bar',
            data: {
              labels: terapiasCommon.map(t => t.key),
              datasets: [{
                label: 'Pacientes',
                data: countsTerapias,
                backgroundColor: 'rgba(99, 230, 190, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Número de casos' } }
              }
            }
          });
        }

        // 8. GRAVEDAD
        const nivelesGravedad = [
          { key: 'Leve', regex: /leve|ligero|minor/i },
          { key: 'Moderado', regex: /moderado|medio/i },
          { key: 'Severo', regex: /severo|grave|sever/i }
        ];

        const countsGravedad = nivelesGravedad.map(({ regex }) =>
          data.filter(r => regex.test(r[campoGravedad] || '')).length
        );

        if (document.getElementById('chartGravedad')) {
          new Chart(document.getElementById('chartGravedad').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: nivelesGravedad.map(n => n.key),
              datasets: [{
                data: countsGravedad,
                backgroundColor: ['rgba(99, 230, 190, 0.6)', 'rgba(255, 212, 59, 0.6)', 'rgba(255, 107, 107, 0.6)']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }

        // Calcular porcentaje de casos con múltiples síntomas
        const casosConMultiplesSintomas = data.filter(r => {
          const sintomas = r[campoSintomas] || '';
          return sintomas.includes(';') || sintomas.includes(',') || 
                (sintomas.toLowerCase().includes('y ') && sintomas !== 'No especificado');
        });
        
        const porcentajeSintomasMultiples = Math.round((casosConMultiplesSintomas.length / data.length) * 100);
        document.getElementById('sintomas-multiples').textContent = `${porcentajeSintomasMultiples}%`;

        // Calcular porcentaje de casos con múltiples terapias
        const casosConMultiplesTerapias = data.filter(r => {
          const terapias = r[campoTerapias] || '';
          return terapias.includes(';') || terapias.includes(',') || 
                (terapias.toLowerCase().includes('y ') && terapias !== 'No especificado');
        });
        
        const porcentajeTerapiasMultiples = Math.round((casosConMultiplesTerapias.length / data.length) * 100);
        document.getElementById('terapias-multiples').textContent = `${porcentajeTerapiasMultiples}%`;

        // Animaciones
        if (window.anime) {
          anime({
            targets: '.panel, .pais-card',
            opacity: [0, 1],
            translateY: [20, 0],
            delay: anime.stagger(100),
            duration: 800,
            easing: 'easeOutQuad'
          });
        }
      } catch (error) {
        console.error('Error en initStats:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Iniciar la carga de datos cuando la página esté lista
    document.addEventListener('DOMContentLoaded', initStats);
  </script>
</body>
</html>
