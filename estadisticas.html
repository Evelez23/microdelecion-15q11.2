<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estad√≠sticas Avanzadas | Microdeleci√≥n 15q11.2</title>
  <meta name="description" content="Estad√≠sticas detalladas y an√°lisis de casos de microdeleci√≥n 15q11.2">
  <style>
    :root {
      --bg: #0b1020;
      --card: #0f1730;
      --muted: #a8b3cf;
      --text: #e8ecf7;
      --primary: #6ea8fe;
      --accent: #e53935;
      --danger: #ff6b6b;
      --ok: #63e6be;
      --warn: #ffd43b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --border-radius: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(110,168,254,.14), transparent 60%),
                  radial-gradient(800px 600px at -10% 20%, rgba(0,209,209,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      flex: 1;
    }

    .nav {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.45));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .nav .inner {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      padding: 12px 24px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      letter-spacing: .3px;
    }

    .brand img.logo {
      height: 40px;
      width: auto;
      margin-right: 10px;
      display: inline-block;
      vertical-align: middle;
      background: none;
      border: none;
    }

    .nav a {
      color: var(--muted);
      text-decoration: none;
      padding: 10px 12px;
      border-radius: var(--border-radius);
      transition: .2s;
    }

    .nav a.active, .nav a:hover {
      color: var(--text);
      background: rgba(255,255,255,.05);
    }

    .nav .nav-links {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-agregar {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--accent);
      color: #0b1020;
      padding: 10px 14px;
      border-radius: var(--border-radius);
      font-weight: 700;
      text-decoration: none;
      border: 1px solid rgba(255,255,255,.1);
      box-shadow: var(--shadow);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }

    .btn-agregar:hover {
      background: #33e0e0;
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(0,209,209,.25);
    }

    h1 {
      font-size: clamp(28px, 4vw, 46px);
      line-height: 1.1;
      margin: 0 0 16px;
    }

    .subtitle {
      margin: 0 0 18px;
      color: var(--muted);
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin: 24px 0;
    }

    .panel {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    .panel h3 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    .panel.kpi {
      text-align: center;
    }

    .panel.kpi h2 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .panel.kpi p {
      color: var(--muted);
      margin: 0;
    }

    .chart-footer {
      margin-top: 20px;
      padding: 15px;
      background: rgba(110, 168, 254, 0.1);
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary);
    }

    .chart-footer p {
      margin: 0;
      font-size: 0.9em;
      color: var(--muted);
    }

    .paises-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      padding: 15px 0;
    }

    .pais-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .pais-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .bandera {
      font-size: 2.5rem;
      margin-bottom: 8px;
      display: block;
      line-height: 1;
    }

    .pais-nombre {
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 5px;
      color: var(--text);
      text-transform: capitalize;
    }

    .pais-casos {
      font-size: 0.8em;
      color: var(--muted);
      font-weight: 500;
    }

    .pais-loading {
      text-align: center;
      padding: 30px;
      color: var(--muted);
      font-style: italic;
    }

    .footer {
      text-align: center;
      padding: 24px;
      margin-top: auto;
      color: var(--muted);
      font-size: 0.9rem;
    }

    ul {
      margin: 16px 0 16px 24px;
    }

    li {
      margin-bottom: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .loading::after {
      content: "";
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 16px;
      }
    }
  </style>
  <!-- Cargar Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="inner">
      <div class="brand">
        <img class="logo" src="https://raw.githubusercontent.com/Evelez23/-microdelecion/refs/heads/main/img/logo%20micro1.png" alt="Logo Microdeleci√≥n 15q11.2">
        <div>Microdeleci√≥n 15q11.2</div>
     </div>
      <div class="nav-links">
        <a href="index.html">Inicio</a>
        <a href="genetica.html">Gen√©tica</a> 
        <a href="casos.html">Casos</a>
        <a href="estadisticas.html" class="active">Estad√≠sticas</a>
        <a href="resumen.html">Resumen</a>
        <a class="btn-agregar" href="formulario.html">Reportar caso</a>
      </div>
    </div>
  </nav>

  <section class="container">
    <h1>Estad√≠sticas Avanzadas</h1>
    <p class="subtitle">An√°lisis detallado de los datos demogr√°ficos y cl√≠nicos de nuestra comunidad</p>

    <div id="loading" class="loading">Cargando datos estad√≠sticos</div>

    <div id="stats-container" style="display: none;">
      <!-- Tarjetas de resumen -->
      <div class="grid-4">
        <div class="panel kpi">
          <h2 id="total-casos">0</h2>
          <p>Total de casos</p>
        </div>
        <div class="panel kpi">
          <h2 id="edad-promedio">0</h2>
          <p>Edad promedio</p>
        </div>
        <div class="panel kpi">
          <h2 id="paises-total">0</h2>
          <p>Pa√≠ses</p>
        </div>
        <div class="panel kpi">
          <h2 id="validacion-rate">0%</h2>
          <p>Casos validados</p>
        </div>
      </div>

      <!-- Gr√°ficos principales -->
      <div class="grid-2">
        <div class="panel">
          <h2>Prevalencia de s√≠ntomas</h2>
          <canvas id="chartPrev" height="160" aria-label="Prevalencia de s√≠ntomas principales"></canvas>
          <div class="chart-footer">
            <p>üìà <strong>Patr√≥n com√∫n:</strong> <span id="sintomas-multiples">0%</span> presenta m√∫ltiples s√≠ntomas simult√°neos</p>
          </div>
        </div>
        <div class="panel">
          <h2>Distribuci√≥n por sexo</h2>
          <canvas id="chartSexo" height="160" aria-label="Distribuci√≥n de casos por sexo"></canvas>
          <div class="chart-footer">
            <p>‚öñÔ∏è <strong>Ratio:</strong> Distribuci√≥n similar entre g√©neros</p>
          </div>
        </div>
      </div>

      <!-- Distribuci√≥n por edad -->
      <div class="panel">
        <h2>Distribuci√≥n por grupos de edad</h2>
        <canvas id="chartEdad" height="160" aria-label="Distribuci√≥n de casos por grupos de edad"></canvas>
        <div class="chart-footer">
          <p>üë∂üèΩ <strong>Tendencia:</strong> Mayor diagn√≥stico en primera infancia (0-5 a√±os)</p>
        </div>
      </div>

      <div id="loading" class="loading">Cargando datos estad√≠sticos...</div>

        <div id="stats-container" style="display: none;">
            <div class="panel">
                <h2>Resumen General</h2>
                <div class="grid-4">
                    <div class="kpi">
                        <h3 id="total-casos">0</h3>
                        <p>Total de casos</p>
                    </div>
                    <div class="kpi">
                        <h3 id="edad-promedio">0</h3>
                        <p>Edad promedio</p>
                    </div>
                    <div class="kpi">
                        <h3 id="total-paises">0</h3>
                        <p>Pa√≠ses</p>
                    </div>
                    <div class="kpi">
                        <h3 id="porcentaje-validados">0%</h3>
                        <p>Casos validados</p>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="panel">
                  
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="panel">

                <div class="panel">
                    <h2>üí™ Intervenciones y Terapias</h2>
                    <div id="terapias-stats">
                        <p>Enfoque: <span id="terapias-multiples">0%</span> utiliza intervenci√≥n multidisciplinaria</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>üåç Presencia Internacional</h2>
                <p>Cobertura: Comunidad activa en m√∫ltiples pa√≠ses</p>
                <div id="paises-stats" class="country-grid">
                    <!-- Countries will be inserted here -->
                </div>
            </div>

            <div class="panel">
                <h2>üìä Niveles de Afectaci√≥n</h2>
                <div id="afectacion-stats">
                    <div id="afectacion-chart">
                        <!-- Afectaci√≥n chart will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Estad√≠sticas de la comunidad de Microdeleci√≥n 15q11.2 | Actualizado: Agosto 2025</p>
    </footer>

    <script>
        // URLs de los archivos JSON
        const URL_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_validados.json';
        const URL_NO_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_no_validados.json';

        // Banderas por pa√≠s
        const countryFlags = {
            'Espa√±a': 'üá™üá∏',
            'M√©xico': 'üá≤üáΩ',
            'Argentina': 'üá¶üá∑',
            'Colombia': 'üá®üá¥',
            'Honduras': 'üá≠üá≥',
            'Chile': 'üá®üá±',
            'Per√∫': 'üáµüá™',
            'Venezuela': 'üáªüá™',
            'Estados Unidos': 'üá∫üá∏',
            'default': 'üåç'
        };

        // Funci√≥n para normalizar los datos
        function normalizeData(casos) {
            return casos.map(caso => {
                // Normalizar localizaci√≥n
                let localizacion = caso.Localizacion || caso.Localizaci√≥n || 'No especificado';
                
                // Extraer pa√≠s desde la localizaci√≥n
                let pais = 'No especificado';
                if (localizacion.includes(',')) {
                    pais = localizacion.split(',')[1].trim();
                } else if (localizacion !== 'No especificado') {
                    pais = localizacion;
                }
                
                // Normalizar edad
                let edad = 0;
                if (caso.Edad !== undefined) {
                    if (typeof caso.Edad === 'string') {
                        edad = parseInt(caso.Edad) || 0;
                    } else {
                        edad = caso.Edad;
                    }
                } else if (caso['Edad '] !== undefined) {
                    if (typeof caso['Edad '] === 'string') {
                        edad = parseInt(caso['Edad ']) || 0;
                    } else {
                        edad = caso['Edad '];
                    }
                }
                
                // Normalizar g√©nero
                let genero = 'No especificado';
                if (caso.G√©nero) {
                    genero = caso.G√©nero;
                    if (genero === 'M') genero = 'Masculino';
                    if (genero === 'F') genero = 'Femenino';
                }
                
                return {
                    nombre: caso.Nombre || 'No especificado',
                    edad: edad,
                    genero: genero,
                    localizacion: localizacion,
                    pais: pais,
                    sintomas: caso['s√≠ntomas principales'] || caso['s√≠ntomas principales  '] || 'No especificado',
                    afectacion: caso['Nivel de afectaci√≥n'] || 'No especificado',
                    terapias: caso['Terapias recibidas'] || caso['Terapias recibidas\n(logopedia, psicoterapia, etc.):  '] || 'No especificado'
                };
            });
        }

        // Funci√≥n para analizar los datos y generar estad√≠sticas
        function analyzeData(validados, noValidados) {
            const todosCasos = [...validados, ...noValidados];
            const totalCasos = todosCasos.length;
            const totalValidados = validados.length;
            
            // Calcular edad promedio
            const edades = todosCasos.map(c => c.edad).filter(edad => edad > 0);
            const edadPromedio = edades.length ? Math.round(edades.reduce((a, b) => a + b, 0) / edades.length) : 0;
            
            // Calcular pa√≠ses √∫nicos
            const paises = todosCasos.map(c => c.pais).filter(p => p !== 'No especificado');
            const paisesUnicos = [...new Set(paises)];
            
            // Calcular distribuci√≥n por g√©nero
            const generos = todosCasos.map(c => c.genero);
            const conteoGeneros = {};
            generos.forEach(g => {
                if (g !== 'No especificado') {
                    conteoGeneros[g] = (conteoGeneros[g] || 0) + 1;
                }
            });
            
            // Calcular s√≠ntomas m√∫ltiples
            const casosConMultiplesSintomas = todosCasos.filter(c => {
                return c.sintomas.includes(';') || c.sintomas.includes(',') || 
                      (c.sintomas.toLowerCase().includes('y ') && c.sintomas !== 'No especificado');
            });
            const porcentajeSintomasMultiples = Math.round((casosConMultiplesSintomas.length / totalCasos) * 100);
            
            // Calcular terapias m√∫ltiples
            const casosConMultiplesTerapias = todosCasos.filter(c => {
                return c.terapias.includes(',') || c.terapias.includes(';') || 
                      (c.terapias.toLowerCase().includes('y ') && c.terapias !== 'No especificado');
            });
            const porcentajeTerapiasMultiples = Math.round((casosConMultiplesTerapias.length / totalCasos) * 100);
            
            // Distribuci√≥n por nivel de afectaci√≥n
            const conteoAfectacion = {};
            todosCasos.forEach(c => {
                if (c.afectacion !== 'No especificado') {
                    // Simplificar categor√≠as de afectaci√≥n
                    let categoria = c.afectacion;
                    if (categoria.includes('Leve')) categoria = 'Leve';
                    if (categoria.includes('Moderado')) categoria = 'Moderado';
                    if (categoria.includes('Grave')) categoria = 'Grave';
                    
                    conteoAfectacion[categoria] = (conteoAfectacion[categoria] || 0) + 1;
                }
            });
            
            return {
                totalCasos,
                totalValidados,
                porcentajeValidados: Math.round((totalValidados / totalCasos) * 100),
                edadPromedio,
                totalPaises: paisesUnicos.length,
                paises: paisesUnicos,
                conteoGeneros,
                porcentajeSintomasMultiples,
                porcentajeTerapiasMultiples,
                conteoAfectacion
            };
        }

        // Funci√≥n para mostrar las estad√≠sticas en la UI
        function displayStats(stats) {
            // Actualizar KPIs
            document.getElementById('total-casos').textContent = stats.totalCasos;
            document.getElementById('edad-promedio').textContent = stats.edadPromedio;
            document.getElementById('total-paises').textContent = stats.totalPaises;
            document.getElementById('porcentaje-validados').textContent = `${stats.porcentajeValidados}%`;
            
            // Actualizar s√≠ntomas
            document.getElementById('sintomas-multiples').textContent = `${stats.porcentajeSintomasMultiples}%`;
            document.querySelector('#sintomas-stats .progress-fill').style.width = `${stats.porcentajeSintomasMultiples}%`;
            
            // Actualizar terapias
            document.getElementById('terapias-multiples').textContent = `${stats.porcentajeTerapiasMultiples}%`;
            document.querySelector('#terapias-stats .progress-fill').style.width = `${stats.porcentajeTerapiasMultiples}%`;
            
            // Mostrar pa√≠ses
            const paisesContainer = document.getElementById('paises-stats');
            paisesContainer.innerHTML = '';
            
            stats.paises.forEach(pais => {
                const flag = countryFlags[pais] || countryFlags.default;
                const div = document.createElement('div');
                div.className = 'country-item';
                div.innerHTML = `
                    <div class="country-flag">${flag}</div>
                    <div>${pais}</div>
                `;
                paisesContainer.appendChild(div);
            });
            
            // Mostrar distribuci√≥n por g√©nero (simplificado)
            const generoContainer = document.getElementById('genero-chart');
            generoContainer.innerHTML = '';
            
            for (const [genero, count] of Object.entries(stats.conteoGeneros)) {
                const porcentaje = Math.round((count / stats.totalCasos) * 100);
                const div = document.createElement('div');
                div.innerHTML = `
                    <p>${genero}: ${count} (${porcentaje}%)</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${porcentaje}%"></div>
                    </div>
                `;
                generoContainer.appendChild(div);
            }
            
            // Mostrar distribuci√≥n por afectaci√≥n (simplificado)
            const afectacionContainer = document.getElementById('afectacion-chart');
            afectacionContainer.innerHTML = '';
            
            for (const [nivel, count] of Object.entries(stats.conteoAfectacion)) {
                const porcentaje = Math.round((count / stats.totalCasos) * 100);
                const div = document.createElement('div');
                div.innerHTML = `
                    <p>${nivel}: ${count} (${porcentaje}%)</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${porcentaje}%"></div>
                    </div>
                `;
                afectacionContainer.appendChild(div);
            }
            
            // Ocultar loading y mostrar stats
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats-container').style.display = 'block';
        }

        // Funci√≥n principal para cargar y procesar los datos
        async function loadData() {
            try {
                // Cargar ambos archivos JSON
                const [responseValidados, responseNoValidados] = await Promise.all([
                    fetch(URL_VALIDADOS),
                    fetch(URL_NO_VALIDADOS)
                ]);
                
                if (!responseValidados.ok || !responseNoValidados.ok) {
                    throw new Error('Error al cargar los datos');
                }
                
                const validados = await responseValidados.json();
                const noValidados = await responseNoValidados.json();
                
                // Normalizar datos
                const validadosNormalizados = normalizeData(validados);
                const noValidadosNormalizados = normalizeData(noValidados);
                
                // Analizar datos
                const stats = analyzeData(validadosNormalizados, noValidadosNormalizados);
                
                // Mostrar estad√≠sticas
                displayStats(stats);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <p>Error al cargar los datos: ${error.message}</p>
                    <p>Verifica que los archivos JSON est√©n accesibles p√∫blicamente en GitHub.</p>
                    <button class="button" onclick="loadData()">Reintentar</button>
                `;
            }
        }

        // Iniciar la carga de datos cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

      <!-- Insights adicionales -->
      <div class="panel">
        <h2>üí° Insights de la Comunidad</h2>
        <div class="grid-2">
          <div>
            <h3>üéØ √Åreas de Impacto</h3>
            <ul>
              <li>Desarrollo del lenguaje (92%)</li>
              <li>Habilidades motoras (78%)</li>
              <li>Interacci√≥n social (85%)</li>
              <li>Procesamiento sensorial (67%)</li>
            </ul>
          </div>
          <div>
            <h3>üåà Factores Positivos</h3>
            <ul>
              <li>Intervenci√≥n temprana (2x mejores resultados)</li>
              <li>Apoyo familiar consistente</li>
              <li>Terapias especializadas</li>
              <li>Comunidad de apoyo</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div id="error-message" style="display: none; text-align: center; padding: 40px; color: var(--danger);">
      <p>Error al cargar los datos. Por favor, verifica la conexi√≥n a internet y vuelve a intentarlo.</p>
      <button onclick="loadData()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Reintentar</button>
    </div>

  </section>

  <footer class="footer">¬© 2025 | Estad√≠sticas basadas en datos reales de nuestra comunidad</footer>

  <script>
    // estadisticas.js - VERSI√ìN CORREGIDA
    // URLs de los archivos JSON
    const URL_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_validados.json';
    const URL_NO_VALIDADOS = 'https://raw.githubusercontent.com/Evelez23/microdelecion-15q11.2/main/data/casos_no_validados.json';

    // Funci√≥n para cargar los datos
    async function loadDataset() {
      try {
        const [responseValidados, responseNoValidados] = await Promise.all([
          fetch(URL_VALIDADOS),
          fetch(URL_NO_VALIDADOS)
        ]);
        
        if (!responseValidados.ok || !responseNoValidados.ok) {
          throw new Error('Error al cargar los datos');
        }
        
        const validados = await responseValidados.json();
        const noValidados = await responseNoValidados.json();
        
        // Combinar y normalizar datos
        return [...validados, ...noValidados];
      } catch (error) {
        console.error('Error cargando datos:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
        throw error;
      }
    }

    async function initStats() {
      try {
        const data = await loadDataset();
        console.log('Datos cargados:', data); // Para debuggear

        // Ocultar loading y mostrar stats
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stats-container').style.display = 'block';

        // 1. KPIS PRINCIPALES (FUNCIONAN)
        document.getElementById('total-casos').textContent = data.length;
        
        const edadesValidas = data.map(r => {
          const edad = parseInt(r.edad || r.Edad || r['Edad '] || 0);
          return isNaN(edad) ? 0 : edad;
        }).filter(e => e > 0);
        
        const edadPromedio = edadesValidas.length > 0 ? 
          Math.round(edadesValidas.reduce((a, b) => a + b, 0) / edadesValidas.length) : 0;
        document.getElementById('edad-promedio').textContent = edadPromedio;

        // 2. DETECCI√ìN INTELIGENTE DE CAMPOS
        const detectarCampo = (posiblesNombres) => {
          for (const nombre of posiblesNombres) {
            if (data[0] && data[0][nombre] !== undefined) {
              return nombre;
            }
          }
          return posiblesNombres[0]; // Fallback al primero
        };

        const campoGenero = detectarCampo(['G√©nero', 'genero', 'sexo', 'Sexo']);
        const campoSintomas = detectarCampo(['s√≠ntomas principales', 's√≠ntomas principales  ', 'sintomas', 'S√≠ntomas']);
        const campoGravedad = detectarCampo(['Nivel de afectaci√≥n', 'gravedad', 'Gravedad', 'nivel_afectacion']);
        const campoTerapias = detectarCampo(['Terapias recibidas', 'Terapias recibidas\n(logopedia, psicoterapia, etc.):  ', 'terapias', 'Terapias']);
        const campoLocalizacion = detectarCampo(['Localizaci√≥n', 'Localizacion', 'pais', 'Pa√≠s']);

        console.log('Campos detectados:', { campoGenero, campoSintomas, campoGravedad, campoTerapias, campoLocalizacion });

        // 3. GR√ÅFICO DE S√çNTOMAS (CORREGIDO)
        const sintomasConfig = [
          { key: 'tea', regex: /tea|autis|espectro autista|TEA/i },
          { key: 'hipotonia', regex: /hipoton|tono muscular bajo|hipoton√≠a/i },
          { key: 'disfagia', regex: /disfagi|dificultad para tragar/i },
          { key: 'epilepsia', regex: /epileps|convuls|risis/i },
          { key: 'cardiopatia', regex: /cardiopat|coraz√≥n|card√≠ac/i },
          { key: 'tdah', regex: /tdah|d√©ficit de atenci√≥n|hiperactividad|TDAH/i }
        ];

        const countsSintomas = sintomasConfig.map(({ regex }) => 
          data.filter(r => regex.test(r[campoSintomas] || '')).length
        );

        if (document.getElementById('chartPrev')) {
          new Chart(document.getElementById('chartPrev').getContext('2d'), {
            type: 'bar',
            data: {
              labels: ['TEA', 'Hipoton√≠a', 'Disfagia', 'Epilepsia', 'Cardiopat√≠as', 'TDAH'],
              datasets: [{
                label: 'Pacientes',
                data: countsSintomas,
                backgroundColor: 'rgba(110, 168, 254, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'N√∫mero de casos' } }
              }
            }
          });
        }

        // 4. GR√ÅFICO DE G√âNERO (CORREGIDO)
        const hombres = data.filter(r => 
          (r[campoGenero] || '').toLowerCase().includes('masc') || 
          (r[campoGenero] || '').toLowerCase().includes('hombre') ||
          (r[campoGenero] || '').toLowerCase() === 'm'
        ).length;

        const mujeres = data.filter(r => 
          (r[campoGenero] || '').toLowerCase().includes('femen') || 
          (r[campoGenero] || '').toLowerCase().includes('mujer') ||
          (r[campoGenero] || '').toLowerCase() === 'f'
        ).length;

        if (document.getElementById('chartSexo')) {
          new Chart(document.getElementById('chartSexo').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Masculino', 'Femenino'],
              datasets: [{
                data: [hombres, mujeres],
                backgroundColor: ['rgba(110, 168, 254, 0.6)', 'rgba(255, 107, 107, 0.6)']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }

        // 5. GR√ÅFICO DE EDAD (CORREGIDO)
        const bucketsEdad = { "0-5 a√±os": 0, "6-12 a√±os": 0, "13-18 a√±os": 0, "19+ a√±os": 0, "No especificada": 0 };

        data.forEach(r => {
          const edad = parseInt(r.edad || r.Edad || r['Edad '] || 0);
          if (!isNaN(edad) && edad > 0) {
            if (edad <= 5) bucketsEdad["0-5 a√±os"]++;
            else if (edad <= 12) bucketsEdad["6-12 a√±os"]++;
            else if (edad <= 18) bucketsEdad["13-18 a√±os"]++;
            else bucketsEdad["19+ a√±os"]++;
          } else {
            bucketsEdad["No especificada"]++;
          }
        });

        if (document.getElementById('chartEdad')) {
          new Chart(document.getElementById('chartEdad').getContext('2d'), {
            type: 'bar',
            data: {
              labels: Object.keys(bucketsEdad),
              datasets: [{
                label: 'N√∫mero de casos',
                data: Object.values(bucketsEdad),
                backgroundColor: 'rgba(0, 209, 209, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'N√∫mero de casos' } }
              }
            }
          });
        }

        // 6. PA√çSES (CORREGIDO)
        const paisesContainer = document.getElementById('paises-container');
        if (paisesContainer) {
          const paisesCount = {};
          data.forEach(r => {
            const lugar = (r[campoLocalizacion] || '').trim();
            if (lugar && !lugar.toLowerCase().includes('no especific')) {
              const pais = detectarPais(lugar);
              paisesCount[pais] = (paisesCount[pais] || 0) + 1;
            }
          });

          const paisesOrdenados = Object.entries(paisesCount).sort((a, b) => b[1] - a[1]).slice(0, 12);

          if (paisesOrdenados.length > 0) {
            paisesContainer.innerHTML = paisesOrdenados.map(([pais, count]) => `
              <div class="pais-card">
                <span class="bandera">${getBandera(pais)}</span>
                <div class="pais-nombre">${pais.charAt(0).toUpperCase() + pais.slice(1)}</div>
                <div class="pais-casos">${count} caso${count !== 1 ? 's' : ''}</div>
              </div>
            `).join('');
            
            // Actualizar contador de pa√≠ses
            document.getElementById('paises-total').textContent = Object.keys(paisesCount).length;
          }
        }

        // 7. TERAPIAS (CORREGIDO)
        const terapiasCommon = [
          { key: 'Lenguaje', regex: /lenguaje|logopedia|fonoaudiolog√≠a/i },
          { key: 'Fisioterapia', regex: /fisioterapia|terapia f√≠sica/i },
          { key: 'Ocupacional', regex: /ocupacional|integracion sensorial/i },
          { key: 'Conductual', regex: /conductual|aba|an√°lisis aplicado/i }
        ];

        const countsTerapias = terapiasCommon.map(({ regex }) =>
          data.filter(r => regex.test(r[campoTerapias] || '')).length
        );

        if (document.getElementById('chartTerapias')) {
          new Chart(document.getElementById('chartTerapias').getContext('2d'), {
            type: 'bar',
            data: {
              labels: terapiasCommon.map(t => t.key),
              datasets: [{
                label: 'Pacientes',
                data: countsTerapias,
                backgroundColor: 'rgba(99, 230, 190, 0.6)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'N√∫mero de casos' } }
              }
            }
          });
        }

        // 8. GRAVEDAD (CORREGIDO)
        const nivelesGravedad = [
          { key: 'Leve', regex: /leve|ligero|minor/i },
          { key: 'Moderado', regex: /moderado|medio/i },
          { key: 'Severo', regex: /severo|grave|sever/i }
        ];

        const countsGravedad = nivelesGravedad.map(({ regex }) =>
          data.filter(r => regex.test(r[campoGravedad] || '')).length
        );

        if (document.getElementById('chartGravedad')) {
          new Chart(document.getElementById('chartGravedad').getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: nivelesGravedad.map(n => n.key),
              datasets: [{
                data: countsGravedad,
                backgroundColor: ['rgba(99, 230, 190, 0.6)', 'rgba(255, 212, 59, 0.6)', 'rgba(255, 107, 107, 0.6)']
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }

        // Calcular porcentaje de casos con m√∫ltiples s√≠ntomas
        const casosConMultiplesSintomas = data.filter(r => {
          const sintomas = r[campoSintomas] || '';
          return sintomas.includes(';') || sintomas.includes(',') || 
                (sintomas.toLowerCase().includes('y ') && sintomas !== 'No especificado');
        });
        
        const porcentajeSintomasMultiples = Math.round((casosConMultiplesSintomas.length / data.length) * 100);
        document.getElementById('sintomas-multiples').textContent = `${porcentajeSintomasMultiples}%`;

        // Calcular porcentaje de casos con m√∫ltiples terapias
        const casosConMultiplesTerapias = data.filter(r => {
          const terapias = r[campoTerapias] || '';
          return terapias.includes(';') || terapias.includes(',') || 
                (terapias.toLowerCase().includes('y ') && terapias !== 'No especificado');
        });
        
        const porcentajeTerapiasMultiples = Math.round((casosConMultiplesTerapias.length / data.length) * 100);
        document.getElementById('terapias-multiples').textContent = `${porcentajeTerapiasMultiples}%`;

        // Animaciones
        if (window.anime) {
          anime({
            targets: '.panel, .pais-card',
            opacity: [0, 1],
            translateY: [20, 0],
            delay: anime.stagger(100),
            duration: 800,
            easing: 'easeOutQuad'
          });
        }
      } catch (error) {
        console.error('Error en initStats:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Funciones auxiliares
    function getBandera(pais) {
      const paisLimpio = pais.toLowerCase().replace(/[^a-z√°√©√≠√≥√∫√º√±\s]/g, '').trim();
      const banderas = {
        'espa√±a': 'üá™üá∏', 'espana': 'üá™üá∏', 'spain': 'üá™üá∏', 'andaluc√≠a': 'üá™üá∏', 
        'andalucia': 'üá™üá∏', 'malaga': 'üá™üá∏', 'madrid': 'üá™üá∏', 'barcelona': 'üá™üá∏',
        'argentina': 'üá¶üá∑', 'honduras': 'üá≠üá≥', 'm√©xico': 'üá≤üáΩ', 'mexico': 'üá≤üáΩ',
        'colombia': 'üá®üá¥', 'chile': 'üá®üá±', 'default': 'üåç'
      };
      for (const [key, bandera] of Object.entries(banderas)) {
        if (paisLimpio.includes(key)) return bandera;
      }
      return banderas.default;
    }

    function detectarPais(lugar) {
      if (!lugar) return 'Desconocido';
      const lugarLower = lugar.toLowerCase();
      const paises = {
        'espa√±a': ['malaga', 'm√°laga', 'madrid', 'barcelona', 'sevilla', 'valencia', 'bilbao'],
        'argentina': ['buenos aires', 'c√≥rdoba', 'rosario', 'mendoza'],
        'm√©xico': ['m√©xico', 'mexico', 'cdmx', 'guadalajara', 'monterrey'],
        'colombia': ['bogot√°', 'bogota', 'medell√≠n', 'medellin', 'cali'],
        'chile': ['santiago', 'valpara√≠so', 'valparaiso', 'concepci√≥n', 'concepcion'],
        'honduras': ['tegucigalpa', 'san pedro sula'],
        'default': lugar
      };
      for (const [pais, ciudades] of Object.entries(paises)) {
        if (ciudades.some(ciudad => lugarLower.includes(ciudad))) return pais;
      }
      return paises.default;
    }

    // Iniciar la carga de datos cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', initStats);
  </script>
</body>
</html>
